---
apiVersion: helm.toolkit.fluxcd.io/v2beta2
kind: HelmRelease
metadata:
  name: internal
spec:
  chart:
    spec:
      chart: kubernetes-ingress
      sourceRef:
        kind: HelmRepository
        name: haproxytech
        namespace: flux-system
      version: 1.35.5
  values:
    controller:
      replicaCount: 3
      ingressClassResource:
        name: haproxy-internal
      service:
        type: LoadBalancer
        externalTrafficPolicy: Local
        externalIPs:
          - 192.168.99.27
      config:
        load-balance: leastconn
        ssl-redirect: 'true'
        syslog-server: "address:stdout, format: raw, facility:daemon"
        scale-server-slots: '2'
        global-config-snippet: |
          lua-prepend-path /usr/local/share/lua/?.lua
          lua-load /usr/local/share/lua/auth-request.lua
        frontend-config-snippet: |
          # Disable auth for specific backends
          acl public-frontends hdr(host) -m reg -i ^(?i)(gate)\.sko\.ai$

          # Authelia needs these headers to work correctly
          http-request set-var(req.scheme) str(https) if { ssl_fc }
          http-request set-var(req.scheme) str(http) if !{ ssl_fc }
          http-request set-var(req.questionmark) str(?) if { query -m found }
          http-request set-header X-Real-IP %[src]
          http-request set-header X-Forwarded-Proto %[var(req.scheme)]
          http-request set-header X-Forwarded-Host %[req.hdr(Host)]
          http-request set-header X-Forwarded-Uri %[path]%[var(req.questionmark)]%[query]

          # Authelia  Config:             Backend name            Path         Method  Request  Success  Failure
          http-request lua.auth-intercept authelia_authelia_http  /api/verify  HEAD    *        remote-*        -
          http-request redirect location https://gate.sko.ai/?rd=%[url] if !public-frontends !{ var(txn.auth_response_successful) -m bool }

          # Security Headers
          http-response set-header X-XSS-Protection "1; mode=block"
          http-response set-header X-Content-Type-Options "nosniff"
          http-response set-header X-Frame-Options "deny"
          http-response set-header Referrer-Policy "strict-origin-when-cross-origin"
      extraArgs:
        - --default-ssl-certificate=cert-manager/sko-ai-tls
      extraVolumes:
      - name: lua
        secret:
          secretName: lua
      extraVolumeMounts:
      - name: lua
        mountPath: /usr/local/share/lua
      resources:
        requests:
          memory: 250Mi
          cpu: 25m
        limits:
          memory: 500Mi
