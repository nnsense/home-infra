---
apiVersion: helm.toolkit.fluxcd.io/v2beta2
kind: HelmRelease
metadata:
  name: internal
spec:
  chart:
    spec:
      chart: kubernetes-ingress
      sourceRef:
        kind: HelmRepository
        name: haproxytech
        namespace: flux-system
      version: 1.35.5
  interval: 1h
  values:
    controller:
      replicaCount: 3
      ingressClassResource:
        name: haproxy-internal
      service:
        type: LoadBalancer
        externalTrafficPolicy: Local
        externalIPs:
          - 192.168.99.27
      config:
        load-balance: leastconn
        ssl-redirect: 'true'
        syslog-server: "address:stdout, format: raw, facility:daemon"
        scale-server-slots: '2'
        global-config-snippet: |
          lua-prepend-path /usr/local/share/lua/?.lua
          lua-load /usr/local/share/lua/auth-request.lua
        frontend-config-snippet: |
          acl public-frontends hdr(host) -m reg -i ^(?i)(gate)\.sko\.ai$
          http-request set-header X-Forwarded-Host %[req.hdr(Host)]
          #                               Backend name            Path         Method  Request  Success  Failure
          http-request lua.auth-intercept authelia_authelia_http  /api/verify  HEAD    *        remote-*        -
          http-request redirect location https://gate.sko.ai/?rd=%[url] if !public-frontends !{ var(txn.auth_response_successful) -m bool }
      extraArgs:
        - --default-ssl-certificate=cert-manager/sko-ai-tls
      extraVolumes:
      - name: lua
        secret:
          secretName: lua
      extraVolumeMounts:
      - name: lua
        mountPath: /usr/local/share/lua
      resources:
        requests:
          memory: 250Mi
          cpu: 25m
        limits:
          memory: 500Mi
