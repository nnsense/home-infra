---
apiVersion: batch/v1
kind: CronJob
metadata:
  name: archiver
spec:
  successfulJobsHistoryLimit: 3
  suspend: false
  concurrencyPolicy: Forbid
  failedJobsHistoryLimit: 1
  schedule: '@midnight'
  jobTemplate:
    spec:
      template:
        spec:
          containers:
          - name: logrotate
            image: public.ecr.aws/docker/library/busybox:1.36.1@sha256:2376a0c12759aa1214ba83e771ff252c7b1663216b192fbe5e0fb364e952f85c
            command:
            - find
            args:
            - /var/logs/k8s
            - -type
            - f
            - -mtime
            - '+30'
            - -delete
            - -print
            resources:
              requests:
                cpu: 10m
                memory: 10Mi
            securityContext:
              allowPrivilegeEscalation: false
              capabilities:
                drop: ["ALL"]
            volumeMounts:
            - name: logging-pvc
              mountPath: /var/logs/k8s
          restartPolicy: Never
          volumes:
          - name: logging-pvc
            persistentVolumeClaim:
              claimName: logging-pvc
