---
kind: Service
apiVersion: v1
metadata:
  name: mailserver
  namespace: mailserver
  labels:
    app: mailserver
spec:
  selector:
    app: mailserver
  ports:
  - name: smtp
    port: 25
    targetPort: smtp
  - name: smtp-secure
    port: 465
    targetPort: smtp-secure
  - name: smtp-auth
    port: 587
    targetPort: smtp-auth
  - name: imap
    port: 143
    targetPort: imap
  - name: imap-secure
    port: 993
    targetPort: imap-secure
  - name: sieve
    port: 4190
    targetPort: sieve
  type: LoadBalancer
  externalTrafficPolicy: Local
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: mailserver
  namespace: mailserver
spec:
  replicas: 1
  strategy:
    type: Recreate
  selector:
    matchLabels:
      app: mailserver
  template:
    metadata:
      labels:
        app: mailserver
        role: mail
        tier: backend
    spec:
      containers:
      - name: mailserver
        image: ghcr.io/docker-mailserver/docker-mailserver:12.1.0@sha256:53c3b3da9fb47f6062210febb112469344e5a9cb319b78238442706fb72a0aca
        securityContext:
          allowPrivilegeEscalation: false
          readOnlyRootFilesystem: false
          runAsUser: 0
          runAsGroup: 0
          runAsNonRoot: false
          privileged: false
          capabilities:
            add:
            # file permission capabilities
            - CHOWN
            - FOWNER
            - MKNOD
            - SETGID
            - SETUID
            - DAC_OVERRIDE
            # network capabilities
            - NET_ADMIN # needed for F2B
            - NET_RAW # needed for F2B
            - NET_BIND_SERVICE
            # miscellaneous  capabilities
            - SYS_CHROOT
            - SYS_PTRACE
            - KILL
            drop: [ALL]
          seccompProfile:
            type: RuntimeDefault
        resources:
          limits:
            memory: 2Gi
            cpu: 1500m
          requests:
            memory: 250Mi
            cpu: 150m
        volumeMounts:
        - name: files
          mountPath: /tmp/docker-mailserver
          readOnly: true
        - name: dkim
          mountPath: /tmp/docker-mailserver/opendkim
          readOnly: true
        - name: opendkim-keys
          mountPath: /tmp/docker-mailserver/opendkim/keys
          readOnly: true

        - name: data
          mountPath: /var/mail
          subPath: data
        - name: data
          mountPath: /var/mail-state
          subPath: state
        - name: data
          mountPath: /var/log/mail
          subPath: log

        - name: tls
          mountPath: /etc/ssl/mailserver
          readOnly: true

        livenessProbe:
          tcpSocket:
            port: 25
          initialDelaySeconds: 15
          periodSeconds: 20
        ports:
        - name: smtp
          containerPort: 25
          protocol: TCP
        - name: smtp-secure
          containerPort: 465
          protocol: TCP
        - name: smtp-auth
          containerPort: 587
        - name: imap
          containerPort: 143
          protocol: TCP
        - name: imap-secure
          containerPort: 993
          protocol: TCP
        - name: sieve
          containerPort: 4190
          protocol: TCP
        envFrom:
        - secretRef:
            name: mailserver.env
      restartPolicy: Always
      volumes:
      - name: files
        secret:
          secretName: mailserver.files
      - name: dkim
        secret:
          secretName: mailserver.dkim
      - name: opendkim-keys
        secret:
          secretName: mailserver.opendkim.keys
      - name: data
        persistentVolumeClaim:
          claimName: mail-storage-data-v3
      - name: tmp-files
        emptyDir: {}
      - name: tls
        secret:
          secretName: mail-cert
