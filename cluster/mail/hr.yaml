---
apiVersion: helm.toolkit.fluxcd.io/v2beta2
kind: HelmRelease
metadata:
  name: mx
spec:
  chart:
    spec:
      chart: app-template
      sourceRef:
        kind: HelmRepository
        name: bjw-s
        namespace: flux-system
      version: 3.1.0
  values:
    controllers:
      mx:
        containers:
          app:
            envFrom:
            - secretRef:
                name: mailserver.env
            image:
              repository: ghcr.io/docker-mailserver/docker-mailserver
              tag: 13.3.1@sha256:33d1dcef8a4e1d9d30f715b82b88c9e99ca16a8c6380c5e40c39b2b7fd710485
            probes:
              liveness:
                enabled: true
              readiness:
                enabled: true
            resources:
              limits:
                cpu: 1500m
                memory: 2Gi
              requests:
                cpu: 150m
                memory: 250Mi
            securityContext:
              allowPrivilegeEscalation: false
              capabilities:
                add:
                - CHOWN
                - FOWNER
                - MKNOD
                - SETGID
                - SETUID
                - DAC_OVERRIDE
                - NET_ADMIN
                - NET_RAW
                - NET_BIND_SERVICE
                - SYS_CHROOT
                - SYS_PTRACE
                - KILL
                drop:
                - ALL
              privileged: false
              readOnlyRootFilesystem: false
              runAsGroup: 0
              runAsNonRoot: false
              runAsUser: 0
              seccompProfile:
                type: RuntimeDefault
        statefulset:
          podManagementPolicy: Parallel
          volumeClaimTemplates:
          - accessMode: ReadWriteOnce
            globalMounts:
            - path: /var/mail
            name: data
            size: 10Gi
            storageClass: nfs-client
          - accessMode: ReadWriteOnce
            globalMounts:
            - path: /var/mail-state
            name: mail-state
            size: 1Gi
        type: statefulset
    persistence:
      files:
        name: mailserver.files
        type: secret
        globalMounts:
        - path: /tmp/docker-mailserver/postfix-accounts.cf
          subPath: postfix-accounts.cf
        - path: /tmp/docker-mailserver/postfix-aliases.cf
          subPath: postfix-aliases.cf
        - path: /tmp/docker-mailserver/whitelist_clients.local
          subPath: whitelist_clients.local
        - path: /tmp/docker-mailserver/postfix-virtual.cf
          subPath: postfix-virtual.cf
      dkim:
        name: mailserver.dkim
        type: secret
        globalMounts:
        - path: /tmp/docker-mailserver/opendkim/KeyTable
          subPath: KeyTable
        - path: /tmp/docker-mailserver/opendkim/keys/sko.ai-mail.key
          subPath: sko.ai-mail.key
        - path: /tmp/docker-mailserver/opendkim/SigningTable
          subPath: SigningTable
        - path: /tmp/docker-mailserver/opendkim/TrustedHosts
          subPath: TrustedHosts
      tls:
        name: mail-sko-ai-tls
        type: secret
        globalMounts:
        - path: /etc/ssl/mailserver
    service:
      app:
        annotations:
          coredns.io/hostname: mail
        controller: mx
        externalIPs:
        - ${EI_MAILSERVER}
        externalTrafficPolicy: Local
        ports:
          smtp:
            primary: true
            port: 25
          imap:
            port: 143
          smtp-secure:
            port: 465
          smtp-auth:
            port: 587
          imap-secure:
            port: 993
          sieve:
            port: 4190
        type: LoadBalancer
