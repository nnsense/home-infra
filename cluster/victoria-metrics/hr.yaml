---
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: vm
  namespace: victoria-metrics
spec:
  chart:
    spec:
      chart: victoria-metrics-k8s-stack
      version: '0.14.17'
      sourceRef:
        kind: HelmRepository
        name: vm-charts
        namespace: flux-system
  interval: 1h0m0s
  targetNamespace: victoria-metrics
  install:
    crds: CreateReplace
  upgrade:
    crds: CreateReplace
  valuesFrom:
    - kind: Secret
      name: vm-secrets
  values:
    fullnameOverride: stack
    experimentalDashboardsEnabled: false
    vmsingle:
      resources:
        limits:
          cpu: 2000m
          memory: 2Gi
        requests:
          cpu: 430m
          memory: 800Mi
    grafana:
      ingress:
        enabled: true
        hosts:
          - gf.sko.ai
      sidecar:
        dashboards:
          enabled: true
          label: grafana_dashboard
          searchNamespace: ALL
      grafana.ini:
        auth.anonymous:
          enabled: true
          org_role: Editor
    alertmanager:
      ingress:
        enabled: true
        hosts:
          - am.sko.ai
      spec:
        externalURL: "https://am.sko.ai"
      config:
        route:
          routes:
          - match:
              alertname: 'Watchdog'
            receiver: 'devnull'
          - match:
              alertname: 'InfoInhibitor'
            receiver: 'devnull'
          - matchers:
              - severity=~"warning|critical"
            receiver: slack-monitoring
        receivers:
          - name: 'devnull'
          - name: "slack-monitoring"
            slack_configs:
              - channel: "#channel"
                send_resolved: true
                title: '{{ template "slack.monzo.title" . }}'
                icon_emoji: '{{ template "slack.monzo.icon_emoji" . }}'
                color: '{{ template "slack.monzo.color" . }}'
                text: '{{ template "slack.monzo.text" . }}'
                actions:
                  - type: button
                    text: "Runbook :green_book:"
                    url: "{{ (index .Alerts 0).Annotations.runbook_url }}"
                  - type: button
                    text: "Query :mag:"
                    url: "{{ (index .Alerts 0).GeneratorURL }}"
                  - type: button
                    text: "Dashboard :grafana:"
                    url: "{{ (index .Alerts 0).Annotations.dashboard }}"
                  - type: button
                    text: "Silence :no_bell:"
                    url: '{{ template "__alert_silence_link" . }}'
                  - type: button
                    text: '{{ template "slack.monzo.link_button_text" . }}'
                    url: "{{ .CommonAnnotations.link_url }}"
    vmalert:
      ingress:
        enabled: true
        hosts:
          - va.sko.ai
    vmagent:
      ingress:
        enabled: true
        hosts:
          - vm.sko.ai
    # Remove useless high cardinality shm mounts
    prometheus-node-exporter:
      vmServiceScrape:
        spec:
          endpoints:
            - port: metrics
              metricRelabelConfigs:
                - action: drop
                  source_labels: [mountpoint]
                  regex: "/run/containerd/.+"
