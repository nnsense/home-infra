---
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: vm
  namespace: victoria-metrics
spec:
  chart:
    spec:
      chart: victoria-metrics-k8s-stack
      version: '0.14.17'
      sourceRef:
        kind: HelmRepository
        name: vm-charts
        namespace: flux-system
  interval: 1h0m0s
  targetNamespace: victoria-metrics
  install:
    crds: CreateReplace
  upgrade:
    crds: CreateReplace
  values:
    fullnameOverride: stack
    grafana:
      ingress:
        enabled: true
        hosts:
          - gf.sko.ai
      sidecar:
        dashboards:
          enabled: true
          label: grafana_dashboard
      grafana.ini:
        auth.anonymous:
          enabled: true
          org_role: Viewer
    alertmanager:
      ingress:
        enabled: true
        hosts:
          - am.sko.ai
    vmalert:
      ingress:
        enabled: true
        hosts:
          - va.sko.ai
    vmagent:
      ingress:
        enabled: true
        hosts:
          - vm.sko.ai
    # Remove useless high cardinality shm mounts
    prometheus-node-exporter:
      vmServiceScrape:
        spec:
          endpoints:
            - port: metrics
              metricRelabelConfigs:
                - action: drop
                  source_labels: [mountpoint]
                  regex: "/run/containerd/.+"
